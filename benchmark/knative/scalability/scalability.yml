- name: Initialize BenchFaster
  ansible.builtin.include_tasks: "{{ playbook_dir }}/deployment/init.yml"
  
- name: Add local container registry
  ansible.builtin.include_tasks: "{{ toolkit_dir }}/registry/registry_add.yml"
  
- name: Install Knative
  ansible.builtin.include_tasks: "{{ toolkit_dir }}/knative/install.yml"

- name: Run scalability test with Hey
  ansible.builtin.shell: |
    hey -c {{ num_threads_item }} -z {{ duration }} -d "{{ loads_item }}" \
      "http://{{ functions_item }}.default.{{ address_benchmark }}.nip.io:{{ knative.port }}" \
    >> {{ results_path.path }}/scalability-{{ functions_item }}_W-{{ num_workers }}_Q-{{ qos_item }}_T-{{ num_threads_item }}_L-{{ loads_item }}.txt

- name: Copy results to control node
  ansible.builtin.command: rsync -a "{{ ansible_user }}"@"{{ ansible_host }}":/home/"{{ ansible_user }}"/benchfaster/_results "{{ playbook_dir }}"/
  delegate_to: 127.0.0.1

- name: Delete BenchFaster
  ansible.builtin.include_tasks: "{{ toolkit_dir }}/delete.yml"