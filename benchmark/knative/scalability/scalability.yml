- name: Initialize BenchFaster
  ansible.builtin.include_tasks: "{{ playbook_dir }}/deployment/init.yml"
  
- name: Add local container registry
  ansible.builtin.include_tasks: "{{ toolkit_dir }}/registry/registry_add.yml"
  
- name: Install Knative
  ansible.builtin.include_tasks: "{{ toolkit_dir }}/knative/install.yml"

- name: Run benchmark per each num_threads and loads
  ansible.builtin.include_tasks: "{{ playbook_dir }}/benchmark/knative/scalability/sub_item.yml"
  vars:
    - num_threads_item: "{{ sub_item.0 }}"
    - loads_item: "{{ sub_item.1 }}"
  loop: "{{ num_threads |  product(loads)  | list }}"
  loop_control:
    loop_var: sub_item

- name: Copy results to control node
  ansible.builtin.command: rsync -a "{{ ansible_user }}"@"{{ ansible_host }}":/home/"{{ ansible_user }}"/benchfaster/_results "{{ playbook_dir }}"/
  delegate_to: 127.0.0.1

- name: Delete BenchFaster
  ansible.builtin.include_tasks: "{{ toolkit_dir }}/delete.yml"